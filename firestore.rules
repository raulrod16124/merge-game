rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===========================
    // USERS COLLECTION
    // ===========================
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      allow update, create: if request.auth != null
        && request.auth.uid == userId
        && isValidUser(request.resource.data);

      function isValidUser(data) {
        return data.uid is string
          && data.name is string
          && data.avatar is map
          && data.avatar.shape is string
          && data.avatar.color is string
          && data.inventory is map
          && data.combinations is map
          && data.coins is number
          && data.authenticated is bool;
      }
    }

    // ===========================
    // PROGRESS COLLECTION
    // ===========================
    match /progress/{userId} {

      allow read, write: if request.auth != null && request.auth.uid == userId;

      allow update, create: if request.auth != null
        && request.auth.uid == userId
        && isValidProgress(request.resource.data);

      function isValidProgress(data) {
        return data.highestLevelUnlocked is number
          && data.unlockedPowerups is list
          && data.unlockedMaps is list
          && data.achievements is map
          && data.coins is number
          && data.cosmicProgress is map
          && data.cosmicProgress.xp is number
          && data.cosmicProgress.level is number
          && data.completedLevelUnlocks is map
          && data.completedLevels is map
          && data.unlockedLevels is list
          && data.unlockedSections is list;
      }
    }

    // ===========================
    // LEADERBOARD
    // ===========================
    match /leaderboard/{uid} {
      allow read: if true;

      allow write: if request.auth != null
        && request.auth.uid == uid
        && isValidLeaderboard(request.resource.data);

      function isValidLeaderboard(data) {
        return data.rankScoreGlobal is number
          && data.rankCosmicLevel is number
          && data.rankTotalCosmicXP is number
          && data.uid is string
          && data.name is string
          && data.avatar is map;
      }
    }

    // ===========================
    // FRIENDS COLLECTION
    // ===========================
    match /friends/{userId} {
      // Cualquier usuario autenticado puede leer docs de friends
      allow read: if request.auth != null;

      // Cualquier usuario autenticado puede escribir, mientras la estructura sea válida
      allow create, update: if request.auth != null
        && isValidFriends(request.resource.data);

      function isValidFriends(data) {
        return data.list is list
            && data.incoming is list
            && data.outgoing is list;
      }
    }

    // ===========================
    // PROFILES COLLECTION
    // ===========================
    match /profiles/{userId} {
      // Cualquiera puede leer perfiles (para ranking, búsqueda, amigos)
      allow read: if true;

      // Solo el propio usuario puede escribir su perfil
      allow write: if request.auth != null
        && request.auth.uid == userId
        && isValidProfile(request.resource.data);

      function isValidProfile(data) {
        return data.uid is string
          && data.name is string
          && data.avatar is map
          && data.avatar.shape is string
          && data.avatar.color is string
          && data.cosmicLevel is number
          && data.totalXP is number
          && data.searchName is string;
      }
    }
    // ===========================
    // CHATS COLLECTION
    // ===========================
    match /chats/{chatId} {
      allow read, write: if request.auth != null
        && request.auth.uid in resource.data.participants;

      match /messages/{messageId} {
        allow read, write: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
  }
}
