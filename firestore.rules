rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===========================
    // USERS COLLECTION
    // ===========================
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      allow update, create: if request.auth != null
        && request.auth.uid == userId
        && isValidUser(request.resource.data);

      function isValidUser(data) {
        return data.uid is string
          && data.name is string
          && data.avatar is map
          && data.avatar.shape is string
          && data.avatar.color is string
          && data.inventory is map
          && data.combinations is map
          && data.coins is number
          && data.authenticated is bool;
      }
    }

    // ===========================
    // PROGRESS COLLECTION
    // ===========================
    match /progress/{userId} {

      allow read, write: if request.auth != null && request.auth.uid == userId;

      allow update, create: if request.auth != null
        && request.auth.uid == userId
        && isValidProgress(request.resource.data);

      function isValidProgress(data) {
        return data.highestLevelUnlocked is number
          && data.unlockedPowerups is list
          && data.unlockedMaps is list
          && data.achievements is map
          && data.coins is number
          && data.cosmicProgress is map
          && data.cosmicProgress.xp is number
          && data.cosmicProgress.level is number
          && data.completedLevelUnlocks is map
          && data.completedLevels is map
          && data.unlockedLevels is list
          && data.unlockedSections is list;
      }
    }

    // ===========================
    // LEADERBOARD
    // ===========================
    match /leaderboard/{uid} {
      allow read: if true;

      allow write: if request.auth != null
        && request.auth.uid == uid
        && isValidLeaderboard(request.resource.data);

      function isValidLeaderboard(data) {
        return data.rankScoreGlobal is number
          && data.rankCosmicLevel is number
          && data.rankTotalCosmicXP is number
          && data.uid is string
          && data.name is string
          && data.avatar is map;
      }
    }
  }
}
